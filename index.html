<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fridge Manager - AJAX Version</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.3.0/fonts/remixicon.css" rel="stylesheet">
    <link href="src/index.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body class="standalone">
    <div class="container py-4">
        <h1>냉장고 관리 v 2.0.0</h1>

        <div class="card mb-4">
            <div class="card-body">
                <h5>항목 관리</h5>
                <div class="row g-3">

                    <div class="col-md-2">
                        <label>ID</label>
                        <input type="number" id="input_id" class="form-control" placeholder="수정/삭제시 필요"/>
                    </div>
                    <div class="col-md-3">
                        <label>상품명 *</label>
                        <input type="text" id="input_name" class="form-control" required/>
                    </div>
                    <div class="col-md-2">
                        <label>수량 *</label>
                        <input type="number" id="input_qty" class="form-control" min="1" required/>
                    </div>
                    <div class="col-md-2">
                        <label>종류 *</label>
                        <select id="input_type" class="form-select" required>
                            <option value="">선택</option>
                            <option>냉장</option>
                            <option>냉동</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label>상태 *</label>
                        <select id="input_status" class="form-select" required>
                            <option value="">선택</option>
                            <option>좋음</option>
                            <option>빨리 먹어야 함</option>
                            <option>폐기 예정</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label>구매일 *</label>
                        <input type="date" id="input_buy" class="form-control" required/>
                    </div>
                    <div class="col-md-3">
                        <label>소비기한 *</label>
                        <input type="date" id="input_expire" class="form-control" required/>
                    </div>
                    <div class="col-md-3">
                        <label>가격(원) *</label>
                        <input type="number" id="input_price" class="form-control" min="0" required/>
                    </div>
                    <div class="col-md-3">
                        <label>비고</label>
                        <input type="text" id="input_note" class="form-control"/>
                    </div>
                </div>
                 <div class="mt-3">
                    <button onclick="addItem()" class="btn btn-success"><i class="ri-add-circle-line"></i> 추가</button>
                    <button onclick="updateItem()" class="btn btn-primary"><i class="ri-edit-2-line"></i> 수정</button>
                    <button onclick="deleteItem()" class="btn btn-danger"><i class="ri-delete-bin-6-line"></i> 삭제</button>
                    <button onclick="getItems()" class="btn btn-info"><i class="ri-refresh-line"></i> 목록 가져오기</button>
                    <button onclick="clearForm()" class="btn btn-secondary">초기화</button>
                </div>
            </div>
        </div>

        <div>
            <h5>목록</h5>
            <div id="div_list" class="table-responsive">
                <table class="table table-bordered table-hover bg-white">
                    <thead class="table-light">
                        <tr>
                            <th>ID</th><th>이름</th><th>종류</th><th>수량</th><th>상태</th>
                            <th>구매일</th><th>소비기한</th><th>가격</th><th>비고</th><th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="tbody"></tbody>
                </table>
            </div>
        </div>
    </div>
    <script>
        const API_URL = "http://localhost:3000/items";
        const fmt = n => new Intl.NumberFormat("ko-KR").format(n);

        function addItem() {
            const xhr = new XMLHttpRequest();
            xhr.open("POST", API_URL);
            xhr.setRequestHeader("content-type", "application/json");

            let data = {
                name: $("#input_name").val(),
                qty: parseInt($("#input_qty").val()),
                type: $("#input_type").val(),
                status: $("#input_status").val(),
                buy: $("#input_buy").val(),
                expire: $("#input_expire").val(),
                price: parseInt($("#input_price").val()),
                note: $("#input_note").val() || ""
            };

            xhr.send(JSON.stringify(data));
            xhr.onload = () => {
                if (xhr.status === 201) {
                    const res = JSON.parse(xhr.response);
                    alert("항목이 추가되었습니다: " + res.name);
                    clearForm();
                    getItems();
                } else {
                    console.log(xhr.status, xhr.statusText);
                    alert("추가 실패");
                }
            }
        }
         function updateItem() {
            const id = $("#input_id").val();
            if (!id) {
                alert("수정할 항목의 ID를 입력하세요");
                return;
            }

            const xhr = new XMLHttpRequest();
            xhr.open("PUT", API_URL + "/" + id);
            xhr.setRequestHeader("content-type", "application/json");

            let data = {
                name: $("#input_name").val(),
                qty: parseInt($("#input_qty").val()),
                type: $("#input_type").val(),
                status: $("#input_status").val(),
                buy: $("#input_buy").val(),
                expire: $("#input_expire").val(),
                price: parseInt($("#input_price").val()),
                note: $("#input_note").val() || ""
            };

            xhr.send(JSON.stringify(data));
            xhr.onload = () => {
                if (xhr.status === 200) {
                    const res = JSON.parse(xhr.response);
                    alert("항목이 수정되었습니다: " + res.name);
                    clearForm();
                    getItems();
                } else {
                    console.log(xhr.status, xhr.statusText);
                    alert("수정 실패");
                }
            }
        }
        function deleteItem() {
            const id = $("#input_id").val();
            if (!id) {
                alert("삭제할 항목의 ID를 입력하세요");
                return;
            }

            if (!confirm("ID " + id + " 항목을 삭제하시겠습니까?")) {
                return;
            }

            const xhr = new XMLHttpRequest();
            xhr.open("DELETE", API_URL + "/" + id);
            xhr.send();
            xhr.onload = () => {
                if (xhr.status === 200) {
                    alert("항목이 삭제되었습니다");
                    clearForm();
                    getItems();
                } else {
                    console.log(xhr.status, xhr.statusText);
                    alert("삭제 실패");
                }
            }
        }
        function getItems() {
            const xhr = new XMLHttpRequest();
            xhr.open("GET", API_URL);
            xhr.setRequestHeader("content-type", "application/json");
            xhr.send();
            xhr.onload = () => {
                if (xhr.status === 200) {
                    const res = JSON.parse(xhr.response);
                    $("#tbody").html("");
                    for (let each of res) {
                        const statusBadge = getStatusBadge(each.status);
                        $("#tbody").append(
                            "<tr>" +
                                "<td>" + each.id + "</td>" +
                                "<td><strong>" + each.name + "</strong></td>" +
                                "<td>" + each.type + "</td>" +
                                "<td>" + each.qty + "</td>" +
                                "<td><span class='badge " + statusBadge + "'>" + each.status + "</span></td>" +
                                "<td>" + each.buy + "</td>" +
                                "<td>" + each.expire + "</td>" +
                                "<td>" + fmt(each.price) + "원</td>" +
                                "<td>" + (each.note || "") + "</td>" +
                                "<td class='text-nowrap'>" +
                                    "<button class='btn btn-sm btn-outline-primary' onclick='loadItem(" + each.id + ")'><i class='ri-edit-2-line'></i></button> " +
                                    "<button class='btn btn-sm btn-outline-danger' onclick='deleteItemById(" + each.id + ")'><i class='ri-delete-bin-6-line'></i></button>" +
                                "</td>" +
                            "</tr>"
                        );
                    }
                } else {
                    console.log(xhr.status, xhr.statusText);
                }
            }
        }
         function getStatusBadge(status) {
            switch(status) {
                case "좋음": return "bg-success";
                case "빨리 먹어야 함": return "bg-warning";
                case "폐기 예정": return "bg-danger";
                default: return "bg-secondary";
            }
        }

        function loadItem(id) {
            const xhr = new XMLHttpRequest();
            xhr.open("GET", API_URL + "/" + id);
            xhr.send();
            xhr.onload = () => {
                if (xhr.status === 200) {
                    const item = JSON.parse(xhr.response);
                    $("#input_id").val(item.id);
                    $("#input_name").val(item.name);
                    $("#input_qty").val(item.qty);
                    $("#input_type").val(item.type);
                    $("#input_status").val(item.status);
                    $("#input_buy").val(item.buy);
                    $("#input_expire").val(item.expire);
                    $("#input_price").val(item.price);
                    $("#input_note").val(item.note);

                    $("html, body").animate({ scrollTop: 0 }, "smooth");
                } else {
                    console.log(xhr.status, xhr.statusText);
                }
            }
        }
         function deleteItemById(id) {
            $("#input_id").val(id);
            deleteItem();
        }

        function clearForm() {
            $("#input_id").val("");
            $("#input_name").val("");
            $("#input_qty").val("");
            $("#input_type").val("");
            $("#input_status").val("");
            $("#input_buy").val("");
            $("#input_expire").val("");
            $("#input_price").val("");
            $("#input_note").val("");
        }

        $(function() {
            getItems();
        });
    </script>
</body>
</html>
